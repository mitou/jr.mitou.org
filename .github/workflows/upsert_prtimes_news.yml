name: Upsert PR TIMES News

on:
  # 2é€±é–“ã”ã¨ã«æ—¥æœ¬æ™‚é–“ã®åˆå‰9æ™‚ã«å®Ÿè¡Œï¼ˆUTC 0æ™‚ã€æ¯æœˆ1æ—¥ã¨15æ—¥ï¼‰
  schedule:
    - cron: '0 0 1,15 * *'
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  upsert-news:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_news.outputs.has_changes }}
    
    steps:
    - name: â˜‘ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ’ Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        bundler-cache: true
    
    - name: ğŸ“£ Check for new PR TIMES articles
      id: check_news
      run: |
        bundle exec rake upsert_prtimes_news
        # _data/news.yml ã®å¤‰æ›´ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
        if [[ -n $(git status --porcelain _data/news.yml) ]]; then
          echo "has_changes=true"  >> $GITHUB_OUTPUT; else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”§ Build & Test
      if: steps.check_news.outputs.has_changes == 'true'
      run: |
        JEKYLL_ENV=test bundle exec jekyll build
        JEKYLL_ENV=test bundle exec jekyll doctor
        SKIP_BUILD=true bundle exec rake test

    - name: ğŸ“ Commit and push if changes exist
      if: steps.check_news.outputs.has_changes == 'true'
      run: |
        git config --global user.name "Yohei Yasukawa"
        git config --global user.email "yohei@yasslab.jp"
        git checkout main
        git add _data/news.yml
        git commit -m "ğŸ¤– Upsert news from PR TIMES RSS feed"
        git push origin main

  deploy:
    needs: upsert-news
    if: needs.upsert-news.outputs.has_changes == 'true' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    - name: â˜‘ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ’ Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        bundler-cache: true
    
    - name: ğŸ”§ Build all pages
      run: |
        JEKYLL_ENV=production bundle exec jekyll build
    
    - name: ğŸš€ Deploy to GitHub Pages
      if: job.status == 'success'
      uses: peaceiris/actions-gh-pages@v4
      with:
        personal_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_site